<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JSON → SRT 转换器（本地）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.4;margin:18px;background:#f7fafc;color:#0f172a}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:#fff;border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06);max-width:980px;margin:auto}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input[type=file]{display:block}
  .drop{border:2px dashed #cbd5e1;padding:18px;border-radius:8px;text-align:center;color:#475569;cursor:pointer}
  .drop.drag{background:#eef2ff;border-color:#6366f1;color:#0f172a}
  textarea{width:100%;height:360px;padding:10px;border-radius:6px;border:1px solid #e2e8f0;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  button.secondary{background:#e2e8f0;color:#0f172a}
  .muted{color:#64748b;font-size:13px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:13px;padding:6px 10px}
  .fileinfo{font-size:13px;color:#475569}
  input[type=text]{padding:8px;border-radius:6px;border:1px solid #e2e8f0}
  .footer{margin-top:12px;color:#94a3b8;font-size:13px}
  .error{color:#ef4444;font-weight:600}
</style>
</head>
<body>
  <div class="card">
    <h1>JSON → SRT 本地转换器</h1>
    <p class="muted">上传你的一类 JSON（每段包含 <code>timestamp</code> 数组和 <code>text</code> 字段），生成标准 SRT 字幕文件并下载，无需上传到服务器。</p>

    <label>选择 JSON 文件 或 拖放到下方</label>
    <div id="drop" class="drop">点击选择文件或将文件拖放到这里</div>
    <input id="fileInput" type="file" accept=".json,application/json" style="margin-top:8px" />

    <div style="margin-top:8px">
      <div class="row">
        <div class="controls">
          <label style="margin:0 8px 0 0">输出文件名：</label>
          <input id="outName" type="text" value="output.srt" />
          <button id="convertBtn" class="small">生成 SRT</button>
          <button id="downloadBtn" class="small secondary" disabled>导出 SRT</button>
          <button id="copyBtn" class="small secondary" disabled>复制 SRT 到剪贴板</button>
          <button id="clearBtn" class="small secondary">清空</button>
        </div>
      </div>
      <div style="margin-top:8px" class="fileinfo" id="fileInfo">未加载文件</div>
    </div>

    <label style="margin-top:12px">SRT 预览（可编辑）</label>
    <textarea id="preview" placeholder="生成后将在此处显示 SRT"></textarea>

    <div class="footer">格式要求示例：<code>[ { "timestamp":[0, 6.96], "text":"文本" }, ... ]</code></div>
    <div id="error" class="error" style="margin-top:8px;display:none"></div>
  </div>

<script>
(function(){
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const fileInfo = document.getElementById('fileInfo');
  const convertBtn = document.getElementById('convertBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const copyBtn = document.getElementById('copyBtn');
  const clearBtn = document.getElementById('clearBtn');
  const preview = document.getElementById('preview');
  const outName = document.getElementById('outName');
  const errorEl = document.getElementById('error');

  let currentJson = null;
  let currentSrt = '';
  let currentFilename = '';

  function showError(msg){
    errorEl.style.display = msg ? 'block' : 'none';
    errorEl.textContent = msg || '';
  }

  // drag & drop handlers
  drop.addEventListener('click', ()=> fileInput.click());
  drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', (e)=>{ e.preventDefault(); drop.classList.remove('drag'); });
  drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('drag'); handleFiles(e.dataTransfer.files); });

  fileInput.addEventListener('change', ()=> handleFiles(fileInput.files));

  function handleFiles(files){
    showError('');
    if(!files || files.length === 0) return;
    const f = files[0];
    currentFilename = f.name;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try {
        const text = ev.target.result;
        const json = JSON.parse(text);
        validateJson(json);
        currentJson = json;
        fileInfo.textContent = `已加载: ${f.name}（${Math.round(f.size/1024)} KB）`;
      } catch(err){
        currentJson = null;
        fileInfo.textContent = '加载失败';
        showError('读取/解析 JSON 出错：' + (err && err.message ? err.message : err));
      }
    };
    reader.onerror = (e)=> {
      showError('读取文件出错');
    };
    reader.readAsText(f, 'utf-8');
  }

  function validateJson(json){
    if(!Array.isArray(json)) throw new Error('JSON 顶层必须是数组。');
    for(let i=0;i<json.length;i++){
      const it = json[i];
      if(!it || !Array.isArray(it.timestamp) || it.timestamp.length < 2) throw new Error(`第 ${i+1} 项缺少有效 timestamp 数组`);
      if(typeof it.text !== 'string') throw new Error(`第 ${i+1} 项缺少 text 字段或不是字符串`);
      // timestamp members must be numbers
      if(typeof it.timestamp[0] !== 'number' || typeof it.timestamp[1] !== 'number') throw new Error(`第 ${i+1} 项 timestamp 必须为数字`);
    }
  }

  function formatTime(seconds){
    // seconds maybe float
    if(typeof seconds !== 'number' || !isFinite(seconds)) seconds = 0;
    const totalMs = Math.round(seconds * 1000);
    const ms = totalMs % 1000;
    const totalSec = Math.floor(totalMs / 1000);
    const s = totalSec % 60;
    const m = Math.floor((totalSec % 3600) / 60);
    const h = Math.floor(totalSec / 3600);
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') + ',' + String(ms).padStart(3,'0');
  }

  function jsonToSrt(json){
    // produce SRT, keep index order
    const lines = [];
    for(let i=0;i<json.length;i++){
      const seg = json[i];
      const start = formatTime(seg.timestamp[0]);
      const end = formatTime(seg.timestamp[1]);
      // normalize text: trim and replace multiple spaces and newlines with single space
      let text = (seg.text || '').trim();
      // preserve intentional newlines encoded as \n in the text
      // but collapse repeated newlines/spaces
      text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      // ensure lines in subtitle are separated by \n
      // we will not forcibly wrap; user can edit preview if needed
      lines.push(String(i+1));
      lines.push(`${start} --> ${end}`);
      lines.push(text);
      lines.push('');
    }
    return lines.join('\n').trim() + '\n';
  }

  convertBtn.addEventListener('click', ()=>{
    showError('');
    if(!currentJson) return showError('请先上传并加载一个符合格式的 JSON 文件。');
    try {
      const srt = jsonToSrt(currentJson);
      currentSrt = srt;
      preview.value = srt;
      downloadBtn.disabled = false;
      copyBtn.disabled = false;
      // smart default filename: if input name present, replace ext
      if(outName.value.trim() === '' || outName.value.trim() === 'output.srt'){
        let base = 'output';
        if(currentFilename){
          base = currentFilename.replace(/\.[^/.]+$/, '');
        }
        outName.value = base + '.srt';
      }
    } catch(err){
      showError('生成 SRT 时出错：' + (err && err.message ? err.message : err));
    }
  });

  downloadBtn.addEventListener('click', ()=>{
    showError('');
    // use content from preview (allow edits)
    const content = preview.value;
    if(!content || content.trim() === '') return showError('当前没有 SRT 内容可导出。请先生成。');
    const filename = outName.value.trim() || 'output.srt';
    const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  copyBtn.addEventListener('click', async ()=>{
    showError('');
    try{
      await navigator.clipboard.writeText(preview.value || '');
      alert('已复制到剪贴板');
    }catch(e){
      showError('复制失败：' + (e && e.message ? e.message : e));
    }
  });

  clearBtn.addEventListener('click', ()=>{
    preview.value = '';
    currentJson = null;
    currentSrt = '';
    currentFilename = '';
    fileInfo.textContent = '未加载文件';
    downloadBtn.disabled = true;
    copyBtn.disabled = true;
    outName.value = 'output.srt';
    showError('');
  });

  // allow user to paste raw JSON text
  window.addEventListener('paste', (e)=>{
    try{
      const txt = (e.clipboardData || window.clipboardData).getData('text');
      if(!txt) return;
      // if clipboard looks like json array, ask user to load
      if(txt.trim().startsWith('[') && txt.includes('"timestamp"')){
        if(confirm('检测到剪贴板内可能含 JSON 文本，是否直接加载为字幕源？')){
          try {
            const j = JSON.parse(txt);
            validateJson(j);
            currentJson = j;
            fileInfo.textContent = `已从剪贴板加载 JSON（${j.length} 条目）`;
          } catch(err){
            showError('剪贴板 JSON 解析失败：' + (err && err.message ? err.message : err));
          }
        }
      }
    }catch(err){}
  });

})();
</script>
</body>
</html>
